name: 'Security Auto Scan'
description: 'è‡ªåŠ¨æ‰«æå’Œæ¸…ç† GitHub Actions ä¸­çš„æ¶æ„ workflow æ–‡ä»¶'
author: 'h7ml'
branding:
  icon: 'shield'
  color: 'red'

inputs:
  github-token:
    description: 'GitHub Token (éœ€è¦ repo å’Œ workflow æƒé™)'
    required: true

  keyword:
    description: 'æœç´¢å…³é”®è¯ï¼ˆæ¶æ„ç‰¹å¾ï¼‰'
    required: false
    default: '.oast.fun'

  dry-run:
    description: 'ä»…æ‰«ææ¨¡å¼ï¼ˆtrue/falseï¼‰'
    required: false
    default: 'false'

  create-issue:
    description: 'å‘ç°å¨èƒæ—¶åˆ›å»º Issueï¼ˆtrue/falseï¼‰'
    required: false
    default: 'true'

  disable-workflows:
    description: 'ç¦ç”¨å—æ„ŸæŸ“ä»“åº“çš„å·¥ä½œæµï¼ˆtrue/falseï¼‰'
    required: false
    default: 'false'

  mask-sensitive-data:
    description: 'æ—¥å¿—è„±æ•ï¼ˆè‡ªåŠ¨éšè—æ•æ„Ÿä¿¡æ¯ - true/falseï¼‰'
    required: false
    default: 'true'

  notification-webhook:
    description: 'Webhook URLï¼ˆæ”¯æŒ Slack/Teams/Discord ç­‰ï¼‰'
    required: false
    default: ''

  notification-template:
    description: 'é€šçŸ¥æ¨¡æ¿ï¼ˆcompact/detailed/customï¼‰'
    required: false
    default: 'detailed'

  report-format:
    description: 'æŠ¥å‘Šè¾“å‡ºæ ¼å¼ï¼ˆmarkdown/json/html/pdfï¼‰'
    required: false
    default: 'markdown'

outputs:
  infected-repos:
    description: 'å—æ„ŸæŸ“ä»“åº“æ•°é‡'

  success-count:
    description: 'æ¸…ç†æˆåŠŸæ•°é‡'

  failed-count:
    description: 'æ¸…ç†å¤±è´¥æ•°é‡'

  report-path:
    description: 'æ‰«ææŠ¥å‘Šè·¯å¾„'

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install -r "${{ github.action_path }}/requirements.txt"

    - name: Setup Git
      shell: bash
      run: |
        git config --global user.name "Security Bot"
        git config --global user.email "security-bot@github.com"

    - name: Run security scan
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        KEYWORD: ${{ inputs.keyword }}
        SCAN_ONLY: ${{ inputs.dry-run }}
        DISABLE_WORKFLOWS: ${{ inputs.disable-workflows }}
        MASK_SENSITIVE_DATA: ${{ inputs.mask-sensitive-data }}
        NOTIFICATION_WEBHOOK: ${{ inputs.notification-webhook }}
        NOTIFICATION_TEMPLATE: ${{ inputs.notification-template }}
        REPORT_FORMAT: ${{ inputs.report-format }}
      run: |
        python "${{ github.action_path }}/scripts/scan.py"

    - name: Set outputs
      shell: bash
      id: scan-result
      run: |
        # è¯»å–æ‰«æç»“æœ
        REPORT_FILE=$(ls -t security/reports/cleanup-report-*.md 2>/dev/null | head -1)

        if [ -f "$REPORT_FILE" ]; then
          INFECTED=$(grep "å—æ„ŸæŸ“ä»“åº“:" "$REPORT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")
          SUCCESS=$(grep "æ¸…ç†æˆåŠŸ:" "$REPORT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")
          FAILED=$(grep "æ¸…ç†å¤±è´¥:" "$REPORT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")

          echo "infected-repos=$INFECTED" >> $GITHUB_OUTPUT
          echo "success-count=$SUCCESS" >> $GITHUB_OUTPUT
          echo "failed-count=$FAILED" >> $GITHUB_OUTPUT
          echo "report-path=$REPORT_FILE" >> $GITHUB_OUTPUT
        else
          echo "infected-repos=0" >> $GITHUB_OUTPUT
          echo "success-count=0" >> $GITHUB_OUTPUT
          echo "failed-count=0" >> $GITHUB_OUTPUT
          echo "report-path=" >> $GITHUB_OUTPUT
        fi

    - name: Upload scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results-${{ github.run_number }}
        path: |
          security/logs/cleanup-*.log
          security/reports/cleanup-report-*.md
        retention-days: 30

    - name: Create Issue if threats found
      if: ${{ inputs.create-issue == 'true' && steps.scan-result.outputs.infected-repos > 0 }}
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const fs = require('fs');
          const reportPath = '${{ steps.scan-result.outputs.report-path }}';

          if (!fs.existsSync(reportPath)) {
            console.log('æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º Issue');
            return;
          }

          const reportContent = fs.readFileSync(reportPath, 'utf8');
          const infectedCount = '${{ steps.scan-result.outputs.infected-repos }}';
          const successCount = '${{ steps.scan-result.outputs.success-count }}';
          const failedCount = '${{ steps.scan-result.outputs.failed-count }}';

          // æå–å¤±è´¥ä»“åº“åˆ—è¡¨
          let failedReposSection = '';
          const failedReposMatch = reportContent.match(/## âŒ å¤±è´¥çš„ä»“åº“\s+([\s\S]*?)(?=\n##|$)/);
          if (failedReposMatch && failedCount !== '0') {
            failedReposSection = '\n### âš ï¸ éœ€è¦æ‰‹åŠ¨å¤„ç†çš„ä»“åº“\n\n' + failedReposMatch[1].trim() + '\n';
          }

          const issueBody = [
            '## ğŸš¨ è‡ªåŠ¨å®‰å…¨æ‰«æå‘ç°å¨èƒ\n',
            '\n> **æ‰§è¡Œæ—¶é—´**: ' + new Date().toLocaleString('zh-CN'),
            '\n> **è¿è¡Œç¼–å·**: [#' + context.runNumber + '](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ')',
            '\n\n---\n',
            '\n## ğŸ“Š æ‰«æç»“æœ\n',
            '\n| æŒ‡æ ‡ | æ•°é‡ |',
            '\n|------|------|',
            '\n| ğŸ” å—æ„ŸæŸ“ä»“åº“ | **' + infectedCount + '** ä¸ª |',
            '\n| âœ… æ¸…ç†æˆåŠŸ | ' + successCount + ' ä¸ª |',
            '\n| âŒ æ¸…ç†å¤±è´¥ | ' + failedCount + ' ä¸ª |',
            failedReposSection,
            '\n\n---\n',
            '\n## ğŸ“‹ å®Œæ•´æŠ¥å‘Š\n',
            '\n<details>',
            '\n<summary>ğŸ“„ ç‚¹å‡»å±•å¼€è¯¦ç»†æŠ¥å‘Š</summary>\n',
            '\n\n```markdown',
            '\n' + reportContent.substring(0, 2000),
            '\n```\n',
            '\n</details>\n',
            '\n\n---\n',
            '\n## ğŸ“ ç›¸å…³èµ„æº\n',
            '\n- ğŸ“¦ [ä¸‹è½½å®Œæ•´ Artifacts](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ')',
            '\n- ğŸ“Š [æŸ¥çœ‹æ‰«ææŠ¥å‘Š](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/tree/main/security/reports)',
            '\n\n---\n',
            '\n## âœ… åç»­æ“ä½œæ¸…å•\n',
            '\n### ğŸ”´ ç«‹å³æ‰§è¡Œ (P0 - 2å°æ—¶å†…)\n',
            failedCount !== '0' ? '\n- [ ] ğŸ”§ **æŸ¥çœ‹å¤±è´¥ä»“åº“åˆ—è¡¨ï¼Œæ‰‹åŠ¨æ¸…ç†**\n' : '',
            '\n- [ ] ğŸ”‘ [æ’¤é”€å½“å‰ä½¿ç”¨çš„ Token](https://github.com/settings/tokens)',
            '\n- [ ] ğŸ”„ è½®æ¢æ‰€æœ‰æ³„éœ²çš„ Secrets',
            '\n- [ ] ğŸ” ä¿®æ”¹æ³„éœ²çš„å¯†ç ',
            '\n\n### ğŸŸ¡ 24å°æ—¶å†…æ‰§è¡Œ (P1)',
            '\n- [ ] ğŸ—ï¸ é‡æ–°ç”Ÿæˆ SSH å¯†é’¥',
            '\n- [ ] ğŸ›¡ï¸ [å¯ç”¨ GitHub 2FA](https://github.com/settings/security)',
            '\n- [ ] ğŸ”’ å¯ç”¨åˆ†æ”¯ä¿æŠ¤è§„åˆ™',
            '\n\n### ğŸŸ¢ 7å¤©å†…æ‰§è¡Œ (P2)',
            '\n- [ ] ğŸ” å®‰å…¨å®¡è®¡',
            '\n- [ ] âœï¸ é…ç½® GPG ç­¾åæäº¤',
            '\n- [ ] ğŸ¤– å¯ç”¨ Dependabot å’Œ CodeQL',
            '\n\n---\n',
            '\n<sub>ğŸ¤– ç”± [Security Auto Scan Action](https://github.com/marketplace/actions/security-auto-scan) è‡ªåŠ¨ç”Ÿæˆ</sub>'
          ].join('');

          try {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ å®‰å…¨è­¦å‘Š: å‘ç° ' + infectedCount + ' ä¸ªæ¶æ„ Workflow - ' + new Date().toISOString().split('T')[0],
              body: issueBody,
              labels: ['security', 'urgent']
            });
            console.log('âœ“ Issue åˆ›å»ºæˆåŠŸ');
          } catch (error) {
            if (error.status === 410) {
              console.log('âš ï¸ Issues åŠŸèƒ½å·²ç¦ç”¨ï¼Œè·³è¿‡åˆ›å»º Issue');
            } else {
              console.error('åˆ›å»º Issue å¤±è´¥:', error.message);
            }
          }
