name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:
    inputs:
      tag:
        description: 'å‘å¸ƒç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: true
        type: string

permissions:
  contents: write
  discussions: write

jobs:
  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œè·å–æ‰€æœ‰æäº¤
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # è·å–ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # ä¿å­˜åˆ°æ–‡ä»¶ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
          echo "$CHANGELOG" > changelog.txt
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: æ„å»ºå‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          cat > release_notes.md <<'EOF'
          ## ğŸ‰ Security Auto Scan ${{ steps.version.outputs.version }}

          ### ğŸ“¦ å®‰è£…æ–¹å¼

          #### æ–¹å¼1ï¼šä» GitHub Marketplace å®‰è£…

          è®¿é—® [GitHub Marketplace](https://github.com/marketplace/actions/security-auto-scan) ç›´æ¥å®‰è£…

          #### æ–¹å¼2ï¼šåœ¨ workflow ä¸­ä½¿ç”¨

          ```yaml
          - name: Security Auto Scan
            uses: h7ml/security-auto-scan@${{ steps.version.outputs.version }}
            with:
              github-token: ${{ secrets.GITHUB_TOKEN }}
              keyword: '.oast.fun'
              dry-run: 'false'
          ```

          ### ğŸ“ å˜æ›´å†…å®¹

          EOF

          if [ -n "${{ steps.changelog.outputs.previous_tag }}" ]; then
            echo "**å®Œæ•´å¯¹æ¯”**: [\`${{ steps.changelog.outputs.previous_tag }}...${{ steps.version.outputs.version }}\`](https://github.com/${{ github.repository }}/compare/${{ steps.changelog.outputs.previous_tag }}...${{ steps.version.outputs.version }})" >> release_notes.md
            echo "" >> release_notes.md
          fi

          cat changelog.txt >> release_notes.md

          cat >> release_notes.md <<'EOF'

          ### ğŸš€ å¿«é€Ÿå¼€å§‹

          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒï¼š
          - [README](https://github.com/${{ github.repository }}#readme)
          - [ä½¿ç”¨ç¤ºä¾‹](https://github.com/${{ github.repository }}/blob/main/EXAMPLES.md)

          ### ğŸ“Š æ”¯æŒçš„åŠŸèƒ½

          - âœ… è‡ªåŠ¨æ‰«ææ‰€æœ‰ä»“åº“ï¼ˆä¸ªäºº + ç»„ç»‡ï¼‰
          - âœ… è‡ªåŠ¨æ¸…ç†æ¶æ„ workflow æ–‡ä»¶
          - âœ… æ—¥å¿—è„±æ•ï¼ˆè‡ªåŠ¨éšè—æ•æ„Ÿä¿¡æ¯ï¼‰
          - âœ… å¤šæ ¼å¼æŠ¥å‘Šï¼ˆMarkdown/JSON/HTML/PDFï¼‰
          - âœ… Webhook é€šçŸ¥ï¼ˆSlack/Discord/Teamsï¼‰
          - âœ… è‡ªåŠ¨åˆ›å»º Issue æŠ¥è­¦
          - âœ… ç¼“å­˜ä¼˜åŒ–ï¼ˆæ€§èƒ½æå‡ 50-80%ï¼‰

          ### âš ï¸ é‡è¦æé†’

          - ä½¿ç”¨å®Œæˆåè¯·ç«‹å³æ’¤é”€ Tokenï¼šhttps://github.com/settings/tokens
          - å»ºè®®å…ˆä½¿ç”¨ `dry-run: true` æµ‹è¯•
          - ç¡®ä¿ Token æ‹¥æœ‰ `repo` å’Œ `workflow` æƒé™

          ---

          **å®Œæ•´æ–‡æ¡£**: https://github.com/${{ github.repository }}
          EOF

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
          discussion_category_name: Announcements
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ›´æ–° major å’Œ minor æ ‡ç­¾
        run: |
          VERSION=${{ steps.version.outputs.version }}
          VERSION_NUM=${{ steps.version.outputs.version_number }}

          # è§£æç‰ˆæœ¬å·
          MAJOR=$(echo $VERSION_NUM | cut -d. -f1)
          MINOR=$(echo $VERSION_NUM | cut -d. -f1-2)

          # æ›´æ–° major æ ‡ç­¾ (å¦‚ v1)
          git tag -fa "v${MAJOR}" -m "Update v${MAJOR} to $VERSION"
          git push origin "v${MAJOR}" --force

          # æ›´æ–° minor æ ‡ç­¾ (å¦‚ v1.0)
          git tag -fa "v${MINOR}" -m "Update v${MINOR} to $VERSION"
          git push origin "v${MINOR}" --force

          echo "âœ… å·²æ›´æ–°æ ‡ç­¾: v${MAJOR}, v${MINOR}"

  marketplace-publish:
    name: å‘å¸ƒåˆ° GitHub Marketplace
    runs-on: ubuntu-latest
    needs: create-release
    if: ${{ !contains(github.ref, 'beta') && !contains(github.ref, 'alpha') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: éªŒè¯ action.yml
        run: |
          # æ£€æŸ¥å¿…éœ€å­—æ®µ
          if ! grep -q "^name:" action.yml; then
            echo "âŒ action.yml ç¼ºå°‘ name å­—æ®µ"
            exit 1
          fi

          if ! grep -q "^description:" action.yml; then
            echo "âŒ action.yml ç¼ºå°‘ description å­—æ®µ"
            exit 1
          fi

          if ! grep -q "branding:" action.yml; then
            echo "âš ï¸ å»ºè®®æ·»åŠ  branding å­—æ®µä»¥æå‡ Marketplace å±•ç¤ºæ•ˆæœ"
          fi

          echo "âœ… action.yml éªŒè¯é€šè¿‡"

      - name: Marketplace å‘å¸ƒè¯´æ˜
        run: |
          cat <<'EOF'

          ğŸ“¢ GitHub Marketplace å‘å¸ƒè¯´æ˜
          ================================

          æ­¤ Action å·²åŒ…å« Marketplace æ‰€éœ€çš„æ‰€æœ‰å…ƒæ•°æ®ï¼š

          âœ… name: Security Auto Scan
          âœ… description: è‡ªåŠ¨æ‰«æå’Œæ¸…ç† GitHub Actions ä¸­çš„æ¶æ„ workflow æ–‡ä»¶
          âœ… branding:
             - icon: shield
             - color: red

          å‘å¸ƒåˆ° Marketplace éœ€è¦ï¼š

          1. é¦–æ¬¡å‘å¸ƒï¼šåœ¨ GitHub ä»“åº“é¡µé¢ç‚¹å‡» "Draft a new release"
          2. å‹¾é€‰ "Publish this Action to the GitHub Marketplace"
          3. åŒæ„ GitHub Marketplace æ¡æ¬¾
          4. åç»­ç‰ˆæœ¬ä¼šè‡ªåŠ¨å‘å¸ƒï¼ˆåªè¦æ¨é€æ–°æ ‡ç­¾ï¼‰

          Marketplace é“¾æ¥ï¼ˆå‘å¸ƒåï¼‰:
          https://github.com/marketplace/actions/security-auto-scan

          EOF

  notify-success:
    name: å‘å¸ƒæˆåŠŸé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [create-release, marketplace-publish]
    if: always()

    steps:
      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒç»“æœ
        run: |
          if [ "${{ needs.create-release.result }}" = "success" ]; then
            echo "âœ… GitHub Release åˆ›å»ºæˆåŠŸ"
            echo "   æŸ¥çœ‹: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          else
            echo "âŒ GitHub Release åˆ›å»ºå¤±è´¥"
          fi

          if [ "${{ needs.marketplace-publish.result }}" = "success" ]; then
            echo "âœ… Marketplace å‘å¸ƒéªŒè¯é€šè¿‡"
            echo "   æŸ¥çœ‹: https://github.com/marketplace/actions/security-auto-scan"
          elif [ "${{ needs.marketplace-publish.result }}" = "skipped" ]; then
            echo "â­ï¸  Marketplace å‘å¸ƒå·²è·³è¿‡ï¼ˆbeta/alpha ç‰ˆæœ¬ï¼‰"
          else
            echo "âš ï¸  Marketplace å‘å¸ƒæ£€æŸ¥å¤±è´¥ï¼ˆè¯·æŸ¥çœ‹æ—¥å¿—ï¼‰"
          fi
